---
layout: post
title:  "2019年09月30日"
description: "TCP/IP介绍" 
categories: life
author: 王武
---

### tcp/ip简介

作为新时代标杆的我们，已经离不开手机、离不开网络，对于互联网大家可能耳熟能详，但是计算机网络的出现比互联网要早很多

#### 1. 什么是协议

在全世界有的说英语，有的说中文，有的说德语，说同一种语言的人可以交流，不同的语言之间就不行了。

为了解决不同种族人之间的语言沟通障碍，现规定国际通用语言是英语，这就是一个规定，这就是协议。

### 2. 计算机网络沟通用什么

现在的生活中，不同的计算机只需要能够联网，就可以相互进行传递数据。

那么不同种类之间的计算机到底是怎么进行数据传递的呢？

就像说不同语言的人沟通一样，只要有一种大家都认可都遵守的协议即可，那么这个计算机都遵守的网络通信协议叫做 `TCP/IP协议`

### 3. TCP/IP协议(族)

​        早期的计算机网络，都是由各厂商自己规定一套协议，IBM、Apple和Microsoft都有各自的网络协议，互不兼容。

​        为了把全世界的所有不同类型的计算机都连接起来，就必须规定一套全球通用的协议，为了实现互联网这个目标，互联网协议族（Internet Protocol Suite）就是通用协议标准。

​        因为互联网协议包含了上百中协议标准，但是最重要的两个协议是TCP和IP协议，所以，大家把互联网的协议简称TCP/IP协议。

网络协议：

![网络协议]({{site.baseurl}}/images/log/2019-09-30/Snip20190930_1.png)

```
网际层也称为：网络层
网络接口层也称为：链接层
```

### 端口

### 1. 什么是端口

那么TCP/IP协议中的端口指的是什么呢？

端口就好比一个房子的门，是出入这间房子的必经之路。



如果一个进程要收发网络数据，那么就需要有这样的端口

在linux系统中，端口可以有65536（2的16次方）个之多！

既然有这么多，操作系统为了统一管理，所以进行了编号，这就是`端口号`

### 2. 端口号

端口是通过端口号来标记的，端口号只有整数，范围是从0到65535

### 3. 端口是怎样分配的

端口号不是随意使用的，而是按照一定的规定进行分配。

端口的分类标准有好几种，我们这里不做详细讲解，只介绍一下知名端口和动态端口。

#### 3.1 知名端口（Well Known Ports）

知名端口是众所周知的端口号，范围从0到1023

```
80端口分配给HTTP服务
21端口分配给FTP服务
```

可以理解为，一些常用的功能使用的号码是设计的，好比 电话号码 110、10086、119一样

一般情况下，如果一个程序需要使用知名端口需要有root权限。

#### 3.2 动态端口（Dynamic Ports）

​       动态端口的范围是从1024到65535

​       之所以称为动态端口，是因为它一般不固定分配给某种服务，而是动态分配

​       动态分配是指当个一系统进程或应用程序进城需要网络通信时，它向主机申请一个端口，主机从可用的端口号中分配一个供它使用。

​       当这个进程关闭时，同时也就释放了所占用的端口号。
## tcp长连接和短链接

TCP在真正的读写操作之前，server与client之间必须建立一个接连，当读写操作完成之后，双方不再需要这个连接时它们可以释放这个连接，连接的建立通过三次握手，释放则需要四次握手，所以说每个连接的建立都是需要资源消耗和时间消耗的。

## TCP通信的整个过程，如下图：

![通信过程]({{site.baseurl}}/images/log/2019-09-30/Snip20191008_1.png)

### 1. TCP短链接

模拟一种TCP短连接的情况：

1. client 向 server 发起连接请求
2. server 接到请求，双方建立连接
3. client 向 server 发送消息
4. server 回应client
5. 一次读写完成，此时双方任何一个都可以发起 close 操作

从上面的描述看，短连接一般只会在 client/server 间传递一次读写操作

### 2. TCP长连接

再模拟一种长连接的情况：

1. client 向 server 发起连接
2. server 接到请求，双方建立连接
3. client 向 server 发送消息
4. server 回应 client
5. 一次读写完成，连接不关闭
6. 后续读写操作...
7. 长时间操作之后client发起关闭请求

## 3.TCP长/短连接操作过程

### 3.1 短连接的操作步骤是：

建立连接——数据传输——关闭连接...建立连接——数据传输——关闭连接

![短连接]({{site.baseurl}}/images/log/2019-09-30/Snip20191008_2.png)

### 3.2 长连接的操作步骤是：

建立连接——数据传输...（保持连接）...数据传输——关闭连接

![长连接]({{site.baseurl}}/images/log/2019-09-30/Snip20191008_3.png)

## TCP长连接/短连接的有点和缺点

- 长连接可以省去较多的TCP建立和关闭的操作，减少浪费，节约时间。
  - 对于频繁请求资源的客户来说，较使用长连接。
- client与server之间的连接如果一直不关闭的话，会存在一个问题，随着客户端连接越来越多，server早晚有扛不住的时候，这时候server端需要采取一些策略：
  - 如关闭一些长时间没有读写事件发生的连接，这样可以避免一些恶意连接导致server端服务受损；
  - 如果条件再允许就可以以客户端机器为颗粒度，限制每个客户端的最大长连接数，这样可以完全避免某个客户端连累后端服务。
- 短连接对于服务器来说管理较为简单，存在的连接都是有用的连接，不需要额外的控制手段。
- 单如果客户端请求频繁，将在TCP的建立和关闭操作上浪费时间和宽带。

## 5. TCP长/短连接的应用场景

- 长连接多用于操作频繁，点对点的通讯，而且连接数不能太多情况。每个TCP连接都需要三次握手，这需要时间，如果每个操作都是先连接，再操作的话那么处理速度会降低很多，所以每个操作完后都不断开，再次处理时直接发送数据包就OK了，不用建立TCP连接。
  - 例如：数据库的连接用长连接，如果用短连接频繁的通信会造成socket错误，而且频繁的socket创建也是对资源的浪费。
- 而像WEB网站的http服务一般都用短连接，因为长连接对于服务端来说会耗费一定的资源，而像WEB网站这么频繁的成千上万甚至上亿客户端的连接用短连接会更省一些资源，如果用长连接，而且同时有成千上万用户，如果每个用户都占用一个连接的话，那可想而知吧。所以并发量大，但每个用户无需频繁操作情况下需用短连接好。